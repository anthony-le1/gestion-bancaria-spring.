<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>THE BANK | Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --bank-dark: #001529; --bank-accent: #1890ff; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }

        .admin-sidebar { background: var(--bank-dark); color: white; min-height: 100vh; }
        .nav-link { color: rgba(255,255,255,0.7); transition: 0.3s; padding: 15px 20px; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--bank-accent); }

        .stat-card {
            background: white; border-radius: 10px; padding: 20px;
            border-bottom: 4px solid var(--bank-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .table-container { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .badge-activa { background-color: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }
        .badge-inactiva { background-color: #fff1f0; color: #f5222d; border: 1px solid #ffa39e; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 p-0 admin-sidebar">
            <div class="p-4 text-center border-bottom border-secondary">
                <img src="logo_bank.png" height="50" class="me-2">
                <h6 class="mt-2 mb-0 fw-bold">ADMIN PORTAL</h6>
            </div>
            <nav class="mt-3">
                <a href="#" class="nav-link active d-block text-decoration-none"><i class="bi bi-people me-2"></i> Gestión de Clientes</a>
                <a href="#" class="nav-link d-block text-decoration-none"><i class="bi bi-shield-lock me-2"></i> Seguridad</a>
                <a href="#" onclick="cerrarSesion()" class="nav-link d-block text-decoration-none mt-5"><i class="bi bi-box-arrow-left me-2"></i> Salir</a>
            </nav>
        </div>

        <div class="col-md-10 p-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Gestión de Cuentas Bancarias</h3>
                <div class="d-flex gap-2">
                    <input type="text" id="searchCedula" class="form-control" placeholder="Buscar por cédula...">
                    <button class="btn btn-primary" onclick="buscarCliente()"><i class="bi bi-search"></i></button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <small class="text-muted">TOTAL DEPÓSITOS</small>
                        <h3 class="fw-bold text-success">$ <span id="totalBanco">0.00</span></h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <small class="text-muted">CUENTAS ACTIVAS</small>
                        <h3 class="fw-bold" id="totalCuentas">0</h3>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Nro. Cuenta</th>
                        <th>Cliente</th>
                        <th>Cédula</th>
                        <th>Saldo</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones de Control</th>
                    </tr>
                    </thead>
                    <tbody id="tablaAdminCuentas">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Actualizar Datos de Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <input type="hidden" id="editNumeroCuenta">
                    <div class="mb-3">
                        <label>Nombre del Titular</label>
                        <input type="text" id="nombreTitular" placeholder="Ingresa el nombre corregido">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" id="editDireccion" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono/Celular</label>
                        <input type="text" id="editTelefono" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" id="editCorreo" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = 'http://localhost:8080/api/cuentas';

    document.addEventListener('DOMContentLoaded', cargarTodasCuentas);

    async function cargarTodasCuentas() {
        const res = await fetch(API_URL);
        const cuentas = await res.json();
        const tbody = document.getElementById('tablaAdminCuentas');

        let totalDinero = 0;
        tbody.innerHTML = cuentas.map(c => {
            totalDinero += c.saldo;
            return `
        <tr>
            <td><strong>${c.numeroCuenta}</strong></td>
            <td>${c.nombreCliente}</td>
            <td>${c.cedula || 'N/A'}</td>
            <td class="fw-bold">$${c.saldo.toFixed(2)}</td>
            <td>
                <span class="badge ${c.estado === 'ACTIVA' ? 'badge-activa' : 'badge-inactiva'}">
                    ${c.estado}
                </span>
            </td>
            <td class="text-center">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-warning" title="Editar Datos"
                        onclick="abrirModalEditar('${c.numeroCuenta}','${c.nombreCliente}', '${c.direccion || ''}', '${c.telefono || ''}', '${c.correo || ''}')">
                        <i class="bi bi-pencil"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-secondary" title="Cambiar Estado" onclick="toggleEstado('${c.numeroCuenta}', '${c.estado}')">
                        <i class="bi bi-power"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-primary" title="Ver Reporte" onclick="verPDF('${c.numeroCuenta}')">
                        <i class="bi bi-file-text"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="eliminarCuenta('${c.numeroCuenta}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `}).join('');

        document.getElementById('totalBanco').innerText = totalDinero.toLocaleString();
        document.getElementById('totalCuentas').innerText = cuentas.length;
    }


    async function toggleEstado(numero, estadoActual) {
        const nuevoEstado = estadoActual === 'ACTIVA' ? 'INACTIVA' : 'ACTIVA';

        const result = await Swal.fire({
            title: '¿Cambiar estado?',
            text: `La cuenta ${numero} pasará a estar ${nuevoEstado}`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#1890ff',
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            await fetch(`${API_URL}/${numero}/estado?nuevoEstado=${nuevoEstado}`, { method: 'PATCH' });
            Swal.fire('Actualizado', `La cuenta ahora está ${nuevoEstado}`, 'success');
            cargarTodasCuentas();
        }
    }
    function cerrarSesion() {
        Swal.fire({
            title: '¿Cerrar sesión?',
            text: "Tendrás que ingresar tus credenciales nuevamente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#002d5a',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, salir',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.clear();
                // Redirige al login o inicio
                window.location.href = 'index.html';
            }
        });
    }
    // Función para descargar el PDF
    function verPDF(numero) {
        const url = `http://localhost:8080/api/cuentas/exportar-pdf/${numero}`;
        console.log("Llamando a:", url);
        window.open(url, '_blank');
    }
    // 1. Función para pedir los nuevos datos (Actualizar)
    async function abrirModalEditar(numero, nombreActual, direccionActual, telefonoActual, correoActual) {
        const { value: formValues } = await Swal.fire({
            title: `Editar Datos - Cuenta ${numero}`,
            html:
            // Agregamos un <br> y estilos básicos para que no se amontone
                `<div class="text-start">` +
                `<label class="small fw-bold">Titular</label>` +
                `<input id="swal-nombre" class="swal2-input" value="${nombreActual}">` +
                `<label class="small fw-bold">Dirección</label>` +
                `<input id="swal-dir" class="swal2-input" value="${direccionActual}">` +
                `<label class="small fw-bold">Teléfono</label>` +
                `<input id="swal-tel" class="swal2-input" value="${telefonoActual}">` +
                `<label class="small fw-bold">Correo</label>` +
                `<input id="swal-email" class="swal2-input" value="${correoActual}">` +
                `</div>`,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Guardar Cambios',
            preConfirm: () => {
                // Es vital que el ID coincida con el del input de arriba
                const nombre = document.getElementById('swal-nombre').value;
                const direccion = document.getElementById('swal-dir').value;
                const telefono = document.getElementById('swal-tel').value;
                const correo = document.getElementById('swal-email').value;

                if (!nombre) {
                    Swal.showValidationMessage('El nombre es obligatorio');
                }

                return {
                    nombreCliente: nombre,
                    direccion: direccion,
                    telefono: telefono,
                    correo: correo
                }
            }
        });

        if (formValues) {
            enviarActualizacion(numero, formValues);
        }
    }

    // 2. Función que hace el PUT al Backend
    async function enviarActualizacion(numero, datos) {
        try {
            const res = await fetch(`${API_URL}/${numero}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos) // Enviamos el JSON al DTO
            });

            if (res.ok) {
                Swal.fire('¡Éxito!', 'Los datos han sido actualizados.', 'success');
                cargarTodasCuentas();
            } else {
                Swal.fire('Error', 'No se pudieron actualizar los datos', 'error');
            }
        } catch (error) {
            console.error("Error al actualizar:", error);
        }
    }

    async function eliminarCuenta(num) {
        const result = await Swal.fire({
            title: '¿Estás totalmente seguro?',
            text: "Esta acción no se puede deshacer. Se eliminarán todos los registros.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar cuenta',
            cancelButtonText: 'Volver atrás'
        });

        if (result.isConfirmed) {
            await fetch(`${API_URL}/${num}`, { method: 'DELETE' });
            Swal.fire('Eliminado', 'El cliente ha sido borrado del sistema.', 'success');
            cargarTodasCuentas();
        }
    }
</script>
</body>
</html>